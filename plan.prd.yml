# Ralphy meta-PRD: generate milestone PRD files for Plan Mode
# Purpose: iterate until validated PRD files exist for each implementation milestone

name: prompt-stack-plan-prd
description: >
  Ralphy meta-PRD that generates, validates, and iterates on PRD files for each
  implementation milestone defined in docs/requirements/main.md. The run will
  continue (with retries) until each milestone PRD exists and validates against
  the repo Ralphy inputs schema and research best-practices checks.
version: 0.1.0
rules_file: docs/opencode-rules.md
style_anchors:
  - docs/requirements/main.md
  - docs/initial-claude-conversation/split-files/03-opencode-integrations-discussion.md
  - docs/best-practices.md
allowed_dependencies:
  - zod
  - eslint
  - vitest
  - prettier

task_sizing:
  min_minutes: 30
  max_minutes: 150
  max_files: 6

tdd:
  required: true
  test_command: pnpm test
  failure_instruction: "Halt generation if tests fail; report and remediate before retry."

ci:
  precommit:
    - pnpm lint
  ci_checks:
    - pnpm test
    - pnpm lint
  count_eslint_disable: true

drift_policy_ref: docs/drift-policy.md
validation_schemas:
  - docs/ralphy-inputs.schema.json
  - src/schemas/*.ts

prompt_template:
  prefix: |
    Repository rules: {{rules_file}}

    Requirements:
    {{requirements_file}}

    Milestone: {{milestone}}
  suffix: |
    Produce a minimal, valid Ralphy PRD file at path: {{output_path}}.
    Ensure:
      - schema validation against docs/ralphy-inputs.schema.json
      - 2-3 style anchors included
      - TDD workflow present
      - affirmative constraints
    Output must be YAML only and include metadata.generated_by and metadata.quality_score.
  placeholders:
    - requirements_file
    - milestone
    - output_path

model_preferences:
  primary: opencode
  review_model: gpt-4
  strategies:
    - minimal-diff
    - generate-3-variants

outputs:
  allowed_file_edits:
    - docs/**
    - plans/**
    - outputs/prds/**
  disallowed_file_edits:
    - scripts/**
    - .github/**
  commit_policy:
    prefix_rules:
      - "feat:"
      - "docs:"
      - "chore:"

# Retry policy used by generation tasks: continue until validation passes or max_attempts reached
retry_policy:
  max_attempts: 6
  backoff_seconds: 10
  success_condition: "file_exists && schema_valid && quality_score >= 0.90"

# Tasks: one generation task per milestone (Phase 1..6 from requirements/main.md)
# Each task generates a PRD file under outputs/prds/, validates it, and will be retried
# according to retry_policy until success_condition is met.
tasks:
  generate-prd-phase-1:
    title: "Generate PRD for Phase 1: MVP (Code Generation)"
    description: |
      Produce a Ralphy PRD that specifies the plan and deliverables for Phase 1 (MVP).
      Include tasks for CLI scaffold, requirements parsing, template-based YAML generation,
      basic validation, and SQLite caching. Output to outputs/prds/phase-1.prd.yml.
    files_in_scope:
      - docs/requirements/main.md
      - templates/meta-prd-generation.yaml
    style_anchors:
      - "docs/requirements/main.md -- Phase list and acceptance criteria"
      - "templates/meta-prd-generation.yaml -- Generation template"
    output_path: outputs/prds/phase-1.prd.yml
    estimated_duration_minutes: 90
    verification:
      post_commit:
        - "your-tool validate outputs/prds/phase-1.prd.yml --schema docs/ralphy-inputs.schema.json"
        - "your-tool review outputs/prds/phase-1.prd.yml --strict"
    completion_signal: "<promise>PHASE_1_COMPLETE</promise>"

  generate-prd-phase-2:
    title: "Generate PRD for Phase 2: Context Optimization"
    description: |
      Produce a Ralphy PRD for Phase 2 (Context Optimization). Specify AST parsing,
      dependency graph, file filtering, token estimation, and budget validation tasks.
      Output to outputs/prds/phase-2.prd.yml.
    files_in_scope:
      - docs/requirements/main.md
      - src/context/**
    style_anchors:
      - "src/context/ast-analyzer.ts -- AST analysis pattern"
      - "docs/initial-claude-conversation/split-files/05-jit-caching.md -- Context budgeting guidance"
    output_path: outputs/prds/phase-2.prd.yml
    estimated_duration_minutes: 120
    verification:
      post_commit:
        - "your-tool validate outputs/prds/phase-2.prd.yml --schema docs/ralphy-inputs.schema.json"
        - "your-tool review outputs/prds/phase-2.prd.yml --strict"
    completion_signal: "<promise>PHASE_2_COMPLETE</promise>"

  generate-prd-phase-3:
    title: "Generate PRD for Phase 3: JIT Discovery"
    description: |
      Produce a PRD outlining interactive interrogation, pattern detection, confidence
      scoring, knowledge export/import, and team-sharing tasks. Output to outputs/prds/phase-3.prd.yml.
    files_in_scope:
      - docs/requirements/main.md
      - src/knowledge/**
    style_anchors:
      - "src/knowledge/discovery.ts -- Discovery & caching patterns"
      - "docs/initial-claude-conversation/split-files/05-jit-caching.md -- JIT discovery design"
    output_path: outputs/prds/phase-3.prd.yml
    estimated_duration_minutes: 150
    verification:
      post_commit:
        - "your-tool validate outputs/prds/phase-3.prd.yml --schema docs/ralphy-inputs.schema.json"
        - "your-tool review outputs/prds/phase-3.prd.yml --strict"
    completion_signal: "<promise>PHASE_3_COMPLETE</promise>"

  generate-prd-phase-4:
    title: "Generate PRD for Phase 4: AI Generation"
    description: |
      Produce a PRD for Phase 4 covering meta-PRD generation, Ralphy integration for
      YAML generation, hybrid mode, and quality validation. Output to outputs/prds/phase-4.prd.yml.
    files_in_scope:
      - templates/meta-prd-generation.yaml
      - src/core/ai-generator.ts
    style_anchors:
      - "templates/meta-prd-generation.yaml -- AI generation template"
      - "src/core/ai-generator.ts -- Generator implementation"
    output_path: outputs/prds/phase-4.prd.yml
    estimated_duration_minutes: 150
    verification:
      post_commit:
        - "your-tool validate outputs/prds/phase-4.prd.yml --schema docs/ralphy-inputs.schema.json"
        - "your-tool review outputs/prds/phase-4.prd.yml --strict"
    completion_signal: "<promise>PHASE_4_COMPLETE</promise>"

  generate-prd-phase-5:
    title: "Generate PRD for Phase 5: AI Review"
    description: |
      Produce a PRD for Phase 5: review PRD generation, research compliance checks,
      quality scoring, and auto-fix suggestions. Output to outputs/prds/phase-5.prd.yml.
    files_in_scope:
      - templates/meta-prd-review.yaml
      - src/core/reviewer.ts
    style_anchors:
      - "templates/meta-prd-review.yaml -- Review PRD template"
      - "src/core/reviewer.ts -- Review rules"
    output_path: outputs/prds/phase-5.prd.yml
    estimated_duration_minutes: 60
    verification:
      post_commit:
        - "your-tool validate outputs/prds/phase-5.prd.yml --schema docs/ralphy-inputs.schema.json"
        - "your-tool review outputs/prds/phase-5.prd.yml --strict"
    completion_signal: "<promise>PHASE_5_COMPLETE</promise>"

  generate-prd-phase-6:
    title: "Generate PRD for Phase 6: Build Mode Integration"
    description: |
      Produce a PRD that specifies Ralphy execution wrapper, progress monitoring,
      post-execution learning, and knowledge updates for Build Mode. Output to outputs/prds/phase-6.prd.yml.
    files_in_scope:
      - src/cli/build.ts
      - src/core/**
    style_anchors:
      - "src/cli/build.ts -- Build mode entrypoint"
      - "docs/requirements/main.md -- Build Mode requirements & targets"
    output_path: outputs/prds/phase-6.prd.yml
    estimated_duration_minutes: 90
    verification:
      post_commit:
        - "your-tool validate outputs/prds/phase-6.prd.yml --schema docs/ralphy-inputs.schema.json"
        - "your-tool review outputs/prds/phase-6.prd.yml --strict"
    completion_signal: "<promise>PHASE_6_COMPLETE</promise>"

  validate-and-aggregate-prds:
    title: "Validate & Aggregate milestone PRDs"
    description: |
      Confirm all milestone PRD files exist and pass schema + research reviews.
      If any PRD is missing or fails review, mark that generation task for retry.
      Produce an aggregated index at outputs/prds/index.yml with metadata and quality scores.
    files_in_scope:
      - outputs/prds/*.prd.yml
    depends_on:
      - generate-prd-phase-1
      - generate-prd-phase-2
      - generate-prd-phase-3
      - generate-prd-phase-4
      - generate-prd-phase-5
      - generate-prd-phase-6
    verification:
      post_commit:
        - "bash -lc 'for f in outputs/prds/*prd.yml; do your-tool validate $f --schema docs/ralphy-inputs.schema.json || exit 1; done'"
        - "your-tool review outputs/prds/*.prd.yml --report json || exit 1"
    output: outputs/prds/index.yml
    completion_signal: "<promise>ALL_PRDS_VALIDATED</promise>"

# Guidance for the Ralphy agent:
# - Use prompt_template placeholders to build generation prompts.
# - For each generate-prd-phase-* task, retry generation until verification passes or retry_policy.max_attempts reached.
# - When retries exceed max_attempts, emit a warning and leave the failing PRD for manual inspection.
# - Aggregate metadata.generated_by and metadata.quality_score into outputs/prds/index.yml

metadata:
  generated_by: "prompt-stack plan.prd generator"
  purpose: "Iteratively produce validated milestone PRDs for Plan Mode testing"
  contact: "dev-team@local"

# End of file
