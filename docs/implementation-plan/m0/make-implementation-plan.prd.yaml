# Planning Phase PRD Template
# Purpose: Generate validated Ralphy YAML inputs for creating implementation plans
# This template follows research-backed best practices from docs/best-practices.md

metadata:
  template_version: "1.0.1"
  template_purpose: "Generate Ralphy YAML inputs for implementation planning"
  generated_by: "planning-phase-prd-template"
  generator_version: "opencode-1.0"
  generated_at: "2026-01-19T08:44:00Z"
  quality_target: 0.95 # Minimum quality score for approval
# Concrete Ralphy inputs added (inferred)
name: "prompt-stack"
description: "Planning-phase Ralphy inputs for prompt-stack implementation plan"
version: "0.1.0"
rules_file: "docs/opencode-rules.md"
style_anchors:
  - "docs/best-practices.md"
  - "docs/ralphy-yaml-spec.md"
allowed_dependencies:
  - "zod"
  - "eslint"
  - "vitest"
task_sizing:
  min_minutes: 30
  max_minutes: 150
  max_files: 5
tdd:
  required: false
  test_command: "pnpm test"
  failure_instruction: "Return failing tests; do not modify tests."
model_preferences:
  primary: "opencode"
  review_model: "gpt-4"
  strategies:
    - "minimal-diff"
outputs:
  allowed_file_edits:
    - "docs/**"
  disallowed_file_edits:
    - ".github/**"
    - "scripts/**"
  commit_policy:
    prefix_rules:
      - "feat:"
      - "fix:"
# Original template metadata preserved for traceability
metadata_original:
  template_version: "1.0.1"
  template_purpose: "Generate Ralphy YAML inputs for implementation planning"
  generated_by: "planning-phase-prd-template"
  generator_version: "opencode-1.0"
  generated_at: "2026-01-19T08:44:00Z"
  quality_target: 0.95 # Minimum quality score for approval
  assumption: true
  assumption_rationale: "Original template metadata preserved when converting to concrete Ralphy inputs."
global_constraints:
  # Research-backed constraints from docs/best-practices.md
  style_anchors_required: 2-3 # Per task, critical for preventing drift
  task_sizing_minutes: 30-150 # Optimal task duration range
  affirmative_constraints: true # Use "do this" not "don't do that"
  context_positioning: "critical-specs-at-edges" # Avoid "lost in middle" problem
  forbidden_patterns:
    - pattern: "\\bany\\b"
      message: "Use unknown with type guards instead"
    - pattern: "@ts-ignore"
      message: "Fix type errors properly"
    - pattern: "eslint-disable"
      message: "Address lint issues instead of disabling"
  required_patterns:
    - pattern: "import.*zod"
      when: "validating_external_data"
    - pattern: "export const.*Schema = z\\.object"
      when: "creating_schemas"
    - pattern: "export type.* = z\\.infer"
      when: "extracting_types"
# Tasks
tasks:
  # Phase 1: Requirements Analysis
  - id: "planning-001"
    title: "Analyze requirements and extract key components"
    description: "Read the provided requirements document and extract:\n1. Core functional requirements\n2. Non-functional requirements (performance, security, etc.)\n3. Integration points with existing systems\n4. Dependencies and constraints\n5. Acceptance criteria\n\nOutput a structured analysis that will inform task breakdown."
    outputs:
      structured_analysis: "structured_analysis.json"
    files_in_scope:
      - "docs/implementation-plan/m0/requirements.md" # Actual requirements file
    style_anchors:
      - file: "docs/requirements/architecture.md"
        reason: "Project architecture and problem framing from requirements"
      - file: "docs/best-practices.md"
        reason: "Coding and review guidelines to prevent drift"
    verification:
      pre_commit:
        - "All requirements categories identified"
        - "No ambiguous requirements left unaddressed"
    output_format: "structured_analysis.json"
    estimated_duration_minutes: 45
    completed: true
  # Phase 2: Codebase Pattern Discovery (from knowledge base)
  - id: "planning-002"
    title: "Retrieve relevant patterns from knowledge base"
    description: "Query the knowledge base for:\n1. Existing style anchors relevant to requirements\n2. Coding standards and patterns for similar tasks\n3. Previous successful task implementations\n4. Common pitfalls to avoid\n\nUse semantic search to find the most relevant patterns."
    depends_on: ["planning-001"]
    outputs:
      patterns_report: "patterns_report.json"
    files_in_scope:
      - ".prompt-stack/knowledge.db" # Path to knowledge DB (default: .prompt-stack/knowledge.db)
      - note: "assumption: true - Knowledge DB may not exist yet; will be created during M0 implementation"
      - "docs/best-practices.md" # Research-backed practices
      - "docs/ralphy-inputs.schema.json"
    style_anchors:
      - file: "docs/initial-claude-conversation/split-files/05-jit-caching.md"
        reason: "JIT caching & pattern discovery examples"
      - file: "docs/initial-claude-conversation/split-files/02-research-report-preventing-drift.md"
        reason: "Pattern examples for similar tasks and drift prevention"
      - file: "examples/style-anchor/pkg/greeter/greeter.go"
        reason: "Concrete code anchor: minimal public package used as coding example"
        assumption: true
        assumption_rationale: "Added to ensure tasks have concrete code anchors for Ralphy prompts"
      - file: "examples/style-anchor/pkg/greeter/greeter_test.go"
        reason: "Test anchor: TDD pattern for simple package"
        assumption: true
        assumption_rationale: "Added to provide test-driven example for planning tasks"
    verification:
      pre_commit:
        - "At least 5 relevant patterns identified"
        - "Style anchors categorized by relevance"
        - "Confidence scores > 0.7 for selected patterns"
    output_format: "patterns_report.json"
    estimated_duration_minutes: 45
    completed: true
  # Phase 3: Task Breakdown and Sizing
  - id: "planning-003"
    title: "Break down requirements into optimally sized tasks"
    description: "Based on requirements analysis and patterns:\n1. Create task breakdown following single responsibility principle\n2. Size each task to 30-150 minute range\n3. Identify dependencies between tasks\n4. Assign appropriate style anchors (2-3 per task)\n5. Estimate context tokens per task\n\nApply research-backed task sizing principles."
    depends_on: ["planning-001", "planning-002"]
    outputs:
      task_breakdown: "task_breakdown.yaml"
    files_in_scope:
      - "structured_analysis.json" # From planning-001
      - "patterns_report.json" # From planning-002
    style_anchors:
      - file: "docs/task-sizing.md"
        reason: "Research basis for task sizing"
      - file: "docs/best-practices.md:171-176"
        reason: "Task sizing research section"
    verification:
      pre_commit:
        - "All tasks sized 30-150 minutes"
        - "Each task has clear single responsibility"
        - "Dependency graph is acyclic"
        - "Style anchors assigned (2-3 per task)"
    output_format: "task_breakdown.yaml"
    estimated_duration_minutes: 60
    completed: true
  # Phase 4: Generate Ralphy YAML Inputs
  - id: "planning-004"
    title: "Generate complete Ralphy YAML inputs"
    description: "Create the final Ralphy YAML inputs file that includes:\n1. Project metadata (name, description, version)\n2. Global constraints and standards\n3. Task definitions with style anchors\n4. Verification steps (pre-commit, post-commit)\n5. Context optimization specifications\n6. Model preferences and strategies\n\nFollow the structure defined in docs/ralphy-inputs.md and ensure produced outputs are declared in 'outputs' for downstream tasks."
    depends_on: ["planning-003"]
    outputs:
      ralphy_inputs: "implementation-plan.yaml"
    files_in_scope:
      - "task_breakdown.yaml" # From planning-003
      - "docs/ralphy-inputs.md" # Input specification
      - "docs/best-practices.md" # Research validation
      - "docs/ralphy-inputs.schema.json"
    style_anchors:
      - file: "docs/ralphy-inputs.md:43-88" # Example minimal Ralphy inputs
        reason: "Reference structure for YAML inputs"
      - file: "docs/ralphy-yaml-spec.md"
        reason: "Ralphy YAML spec examples"
    required_patterns:
      - "name: "
      - "description: "
      - "version: "
      - "tasks:"
      - "style_anchors:"
      - "verification:"
    verification:
      pre_commit:
        - "YAML structure matches docs/ralphy-inputs.md"
        - "All required fields present"
        - "Style anchors (2-3) per task"
        - "Affirmative constraints used"
    output_format: "implementation-plan.yaml"
    estimated_duration_minutes: 45
    completed: true
  # Phase 4a: YAML syntax validation (new)
  - id: "planning-004a"
    title: "Validate YAML syntax using validator tool"
    description: "Run the YAML validator tool to ensure the generated Ralphy inputs have valid YAML syntax and structure. This validates basic YAML correctness before schema validation."
    depends_on: ["planning-004"]
    outputs:
      yaml_validation: "yaml_validation_report.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "tools/validate_yaml.go"
      - "docs/ralphy-yaml-spec.md"
    style_anchors:
      - file: "tools/validate_yaml.go"
        reason: "YAML validator tool implementation"
      - file: "docs/ralphy-yaml-spec.md"
        reason: "Yaml spec examples for validation rules"
    verification:
      pre_commit:
        - "YAML syntax validation passes using tools/validate_yaml.go"
        - "No YAML parsing errors or structural issues"
    output_format: "yaml_validation_report.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 4b: Schema validation (new)
  - id: "planning-004b"
    title: "Validate generated Ralphy YAML against JSON Schema"
    description: "Run JSON Schema validation of the generated Ralphy inputs against docs/ralphy-inputs.schema.json. Fail on schema errors and include detailed diagnostics."
    depends_on: ["planning-004a"]
    outputs:
      schema_validation: "schema_validation_report.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/ralphy-inputs.schema.json"
      - "docs/ralphy-yaml-spec.md"
    style_anchors:
      - file: "docs/ralphy-inputs.schema.json"
        reason: "JSON Schema reference for Ralphy inputs"
      - file: "docs/ralphy-yaml-spec.md"
        reason: "Yaml spec examples for validation rules"
    verification:
      pre_commit:
        - "JSON Schema validation passes against docs/ralphy-inputs.schema.json"
    output_format: "schema_validation_report.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 4c: Secrets and sensitive-data scan (new)
  - id: "planning-004c"
    title: "Scan generated YAML for embedded secrets"
    description: "Ensure no API keys, tokens, or secrets are present in the generated YAML. If secrets are required, confirm they are referenced via secure vault/env and not in the file."
    depends_on: ["planning-004b"]
    outputs:
      secrets_scan: "secrets_scan_report.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/requirements/main.md"
    verification:
      pre_commit:
        - "Zero embedded secrets found (api_key, secret, AWS, private_key patterns)"
        - "Any required secrets are referenced via vault or env placeholders"
    output_format: "secrets_scan_report.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 5: AI Validation - Style Anchors Compliance
  - id: "planning-005"
    title: "Validate style anchors compliance"
    description: "Review the generated Ralphy YAML to ensure:\n1. Each task has 2-3 style anchors\n2. Style anchors are relevant to task type\n3. Anchor files exist in the codebase\n4. Anchor reasons are specific and helpful\n\nThis is critical for preventing architectural drift."
    depends_on: ["planning-004"]
    outputs:
      anchors_validation: "validation_report_anchors.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/best-practices.md:164-170" # Style anchors research section
    style_anchors:
      - file: "docs/initial-claude-conversation/split-files/02-research-report-preventing-drift.md"
        reason: "Research basis for anchor importance"
      - file: "docs/best-practices.md"
        reason: "Best-practices excerpt"
      - file: "examples/style-anchor/pkg/greeter/greeter.go"
        reason: "Concrete code anchor: minimal public package"
        assumption: true
        assumption_rationale: "Added concrete repo anchor for Ralphy prompts; verify acceptance"
      - file: "examples/style-anchor/cmd/mytool/main.go"
        reason: "Concrete code anchor: CLI layout example"
        assumption: true
        assumption_rationale: "Added concrete repo anchor for Ralphy prompts; verify acceptance"
    verification:
      pre_commit:
        - "All tasks have 2-3 style anchors"
        - "Anchor relevance score > 0.8"
        - "Anchor files exist and are accessible"
        - "Anchor reasons are specific (not generic)"
    output_format: "validation_report_anchors.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 6: AI Validation - Task Sizing Compliance
  - id: "planning-006"
    title: "Validate task sizing compliance"
    description: "Review task sizing to ensure:\n1. All tasks are 30-150 minutes\n2. No task is too large (risk of context overflow)\n3. No task is too small (inefficient overhead)\n4. Task dependencies are properly sequenced\n\nFlag any tasks that need splitting or merging."
    depends_on: ["planning-004"]
    outputs:
      sizing_validation: "validation_report_sizing.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/task-sizing.md" # Task sizing heuristics
    style_anchors:
      - file: "docs/task-sizing.md"
        reason: "Example of optimal task sizing validation"
      - file: "examples/style-anchor/pkg/greeter/greeter.go"
        reason: "Concrete code anchor: demonstrates minimal package and tests"
        assumption: true
        assumption_rationale: "Added to satisfy 2-3 anchor requirement with repo examples"
    verification:
      pre_commit:
        - "All tasks within 30-150 minute range"
        - "No task exceeds max_files limit"
        - "Dependency graph is optimal"
        - "Parallel execution opportunities identified"
    output_format: "validation_report_sizing.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 7: AI Validation - Affirmative Constraints
  - id: "planning-007"
    title: "Validate affirmative constraints usage"
    description: "Review constraints to ensure:\n1. All constraints use affirmative language (\"do this\")\n2. No negative phrasing (\"don't do that\")\n3. Constraints are specific and actionable\n4. Constraints reference existing patterns when possible\n\nResearch shows 40%+ better compliance with affirmative framing."
    depends_on: ["planning-004"]
    outputs:
      constraints_validation: "validation_report_constraints.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/best-practices.md:178-183" # Affirmative constraints research
    style_anchors:
      - file: "docs/best-practices.md"
        reason: "Constraint patterns reference best-practices guidance"
      - file: "examples/style-anchor/pkg/greeter/greeter_test.go"
        reason: "Test anchor: TDD example for validation checks"
        assumption: true
        assumption_rationale: "Added test file anchor to ensure planning tasks reference concrete tests"
    verification:
      pre_commit:
        - "Zero instances of negative phrasing"
        - "All constraints are affirmative"
        - "Constraints reference existing patterns"
        - "Constraints are specific and testable"
    output_format: "validation_report_constraints.json"
    estimated_duration_minutes: 30
    note: "assumption: true - shorter duration increased to meet task sizing policy"
    completed: true
    # Phase 8: AI Validation - Implementation Guidelines Compliance (planning only — no tests generated)
  - id: "planning-008"
    title: "Validate implementation guidelines inclusion"
    description: |
      Review the generated plan to ensure implementation-phase guidelines are present where applicable. Specifically:
      1. Identify tasks that will require test-first workflows at implementation time
      2. Ensure task descriptions include 'testable' acceptance criteria when appropriate
      3. Reference implementation guidance and style anchors for the implementation team

      Note: This planning-phase template does NOT generate tests or TDD artifacts; it only records guidance for later implementation phases.
    depends_on: ["planning-004"]
    outputs:
      implementation_guidelines_validation: "validation_report_implementation_guidelines.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/best-practices.md" # Implementation guidance reference
    style_anchors:
      - file: "docs/best-practices.md"
        reason: "Best-practices excerpt as implementation guideline reference"
    verification:
      pre_commit:
        - "Implementation guidelines identified for tasks that will need tests during implementation"
        - "Testable acceptance criteria referenced where appropriate"
        - "No tests are generated in the planning phase"
    output_format: "validation_report_implementation_guidelines.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 9: AI Validation - Multi-Layer Enforcement
  - id: "planning-009"
    title: "Validate multi-layer enforcement and commit/scope policies"
    description: "Review verification layers to ensure:\n1. Prompt-level constraints in YAML\n2. IDE/LSP integration considerations\n3. Pre-commit hook specifications\n4. CI check definitions\n5. Runtime validation where applicable\n6. Commit/revert and file-scope enforcement (atomic commits, files_in_scope enforcement)\n\nMulti-layer enforcement is critical for preventing drift. Reference docs/opencode-rules.md and docs/requirements/main.md for commit policy."
    depends_on: ["planning-004"]
    outputs:
      enforcement_validation: "validation_report_enforcement.json"
    files_in_scope:
      - "implementation-plan.yaml"
      - "docs/best-practices.md:184-193" # Multi-layer enforcement research
      - "docs/opencode-rules.md"
      - "docs/requirements/main.md"
      - "docs/drift-policy.md"
    style_anchors:
      - file: "docs/opencode-rules.md"
        reason: "Project-level rules & constraints"
    verification:
      pre_commit:
        - "At least 3 verification layers specified"
        - "Pre-commit hooks defined"
        - "CI checks included"
        - "Runtime validation for critical paths"
        - "Files_in_scope present for all tasks"
        - "Commit-per-task behavior documented or flag set"
        - "Scope enforcement rules present (flag drift detection)"
    output_format: "validation_report_enforcement.json"
    estimated_duration_minutes: 30
    completed: true
  # Phase 10: Generate Final Quality Report
  - id: "planning-010"
    title: "Generate comprehensive quality report"
    description: "Aggregate all validation results and generate:\n1. Overall quality score (0.0-1.0)\n2. Detailed issue breakdown\n3. Recommendations for improvement\n4. Approval status (APPROVED/REJECTED/NEEDS_REVISION)\n\nQuality score must be ≥0.95 for approval."
    depends_on: ["planning-005", "planning-006", "planning-007", "planning-008", "planning-009", "planning-004a", "planning-004b", "planning-004c"]
    outputs:
      final_quality_report: "final_quality_report.json"
    files_in_scope:
      - "validation_report_anchors.json"
      - "validation_report_sizing.json"
      - "validation_report_constraints.json"
      - "validation_report_implementation_guidelines.json"
      - "validation_report_enforcement.json"
      - "yaml_validation_report.json"
      - "schema_validation_report.json"
      - "secrets_scan_report.json"
    style_anchors:
      - file: "docs/best-practices.md"
        reason: "Example of comprehensive quality reporting"
      - file: "examples/style-anchor/README.md"
        reason: "Repo example README describing style-anchor layout"
        assumption: true
        assumption_rationale: "Added README as contextual anchor for final quality/reporting expectations"
    verification:
      pre_commit:
        - "All validation reports aggregated"
        - "Quality score calculated (0.0-1.0)"
        - "Issue categorization complete"
        - "Clear recommendations provided"
    output_format: "final_quality_report.json"
    estimated_duration_minutes: 30
    note: "assumption: true - increased to meet task sizing policy"
    completed: true
  # Phase 11: Apply Fixes and Generate Final YAML
  - id: "planning-011"
    title: "Apply fixes and generate final Ralphy YAML"
    description: "Based on quality report recommendations:\n1. Apply automatic fixes where possible\n2. Flag issues requiring manual intervention\n3. Regenerate Ralphy YAML with improvements\n4. Create final version with quality score metadata\n\nOnly proceed if quality score ≥0.95."
    depends_on: ["planning-010"]
    outputs:
      final_ralphy_inputs: "final_implementation-plan.yaml"
    files_in_scope:
      - "implementation-plan.yaml" # Initial version
      - "final_quality_report.json"
    style_anchors:
      - file: "docs/best-practices.md"
        reason: "Example of final YAML generation with fixes"
    verification:
      pre_commit:
        - "Quality score ≥0.95"
        - "Critical issues resolved"
        - "All warnings addressed or justified"
        - "Final YAML passes all validations (yaml syntax, schema, secrets, constraints)"
    output_format: "final_implementation-plan.yaml"
    estimated_duration_minutes: 30
    note: "assumption: true - increased to meet task sizing policy"
    completed: true
    completion_signal: "<promise>PLANNING_COMPLETE</promise>"
# Template Usage Instructions
instructions: |
  This template generates validated Ralphy YAML inputs for implementation planning.

  Usage:
  1. Replace {{placeholders}} with actual values or provide equivalent runtime mappings:
     - {{requirements_file}}: Path to requirements document (required). You may pass this mapping at runtime or replace the placeholder with an explicit path.

  2. Output placeholder mapping (the template publishes named outputs for each task):
     - planning-001 outputs.structured_analysis => structured_analysis.json
     - planning-002 outputs.patterns_report => patterns_report.json
     - planning-003 outputs.task_breakdown => task_breakdown.yaml
     - planning-004 outputs.ralphy_inputs => implementation-plan.yaml
     - planning-004a outputs.yaml_validation => yaml_validation_report.json
     - planning-004b outputs.schema_validation => schema_validation_report.json
     - planning-004c outputs.secrets_scan => secrets_scan_report.json
     - planning-005..planning-011 outputs are similarly named and used by downstream tasks

  3. Required pre-conditions:
     - Knowledge base (.prompt-stack/knowledge.db) should be populated for best results
     - docs/best-practices.md, docs/ralphy-inputs.schema.json, docs/ralphy-yaml-spec.md, docs/task-sizing.md, docs/drift-policy.md, docs/opencode-rules.md must be available in repo
     - Examples under examples/style-anchor/ are optional; the template prefers real code anchors in the repo

  4. Execution flow:
     - Run tasks sequentially according to dependencies
     - Each task validates its output before proceeding
     - Final output: final_implementation-plan.yaml (quality ≥0.95)

  5. Quality gates:
     - Style anchors: 2-3 per task (critical)
     - Task sizing: 30-150 minutes (optimal)
     - Affirmative constraints: 100% compliance
     - TDD workflow: Where applicable
     - Multi-layer enforcement: ≥3 layers
     - No embedded secrets in final YAML
     - Final YAML MUST pass YAML syntax validation using tools/validate_yaml.go
     - Final YAML MUST pass JSON Schema validation in docs/ralphy-inputs.schema.json

  6. Output artifacts:
     - final_implementation-plan.yaml: Ready for Ralphy execution
     - final_quality_report.json: Detailed validation results
     - Intermediate analysis and validation reports
# Research Compliance Summary
research_compliance:
  style_anchors: "CRITICAL - 40%+ quality improvement"
  task_sizing: "CRITICAL - Prevents context overflow"
  affirmative_constraints: "HIGH - 40%+ better compliance"
  # Note: TDD integration is part of implementation; this planning-phase template does not require creating tests. If you want to include TDD checks in later phases, add appropriate tasks in the implementation template.
  multi_layer_enforcement: "CRITICAL - Prompt-level rules insufficient"
  context_positioning: "MEDIUM - Avoid 'lost in middle' problem"
  self_consistency: "MEDIUM - 30%+ error reduction"
  model_specific_strategies: "LOW - Implementation detail"
# Expected Performance
performance_targets:
  total_duration_minutes: 190 # Sum of all task estimates (approx)
  parallel_opportunities: "Limited (sequential analysis)"
  context_reduction_target: "80%+ vs naive approach"
  quality_score_target: ">=0.95"
  first_pass_success_target: ">=90%"
