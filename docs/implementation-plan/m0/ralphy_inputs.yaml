name: prompt-stack
description: AI-assisted development workflow tool with Plan/Build modes for generating and validating Ralphy YAML files
version: 0.1.0
rules_file: docs/opencode-rules.md
style_anchors:
  - docs/best-practices.md
  - docs/ralphy-inputs.md
  - examples/style-anchor/cmd/mytool/main.go
allowed_dependencies:
  - cobra
  - better-sqlite3
  - go
task_sizing:
  min_minutes: 30
  max_minutes: 150
  max_files: 5
tdd:
  required: false
  test_command: go test -v ./...
  failure_instruction: Return failing tests; do not modify tests.
ci:
  precommit:
    - go vet ./...
    - gofmt -l .
    - go test ./...
  ci_checks:
    - go test -v ./...
    - go vet ./...
    - go build ./...
drift_policy_ref: docs/drift-policy.md
validation_schemas:
  - docs/implementation-plan/m0/*.schema.json
prompt_template:
  prefix: "Project rules:\n{{rules_file}}\n\nStyle anchors: {{style_anchors}}\n\nTask:\n"
  suffix: "\nMake minimal changes. Run tests after each change. Commit when all tests pass."
  placeholders:
    rules_file: true
    style_anchors: true
model_preferences:
  primary: opencode
  review_model: gpt-4
  strategies:
    - minimal-diff
outputs:
  allowed_file_edits:
    - cmd/**
    - pkg/**
    - docs/implementation-plan/m0/**
    - Makefile
    - go.mod
    - go.sum
  disallowed_file_edits:
    - .github/**
    - scripts/**
    - .prompt-stack/vendor/**
  commit_policy:
    prefix_rules:
      - "feat:"
      - "fix:"
      - "test:"
      - "docs:"
    require_scope: true
    require_conventional_commits: true

global_constraints:

  forbidden_patterns:
    - pattern: "\\bany\\b"
      when: "type_annotations"
      message: "ALWAYS use unknown with type guards in place of any"
    - pattern: "@ts-ignore"
      when: "typescript_error_handling"
      message: "ALWAYS fix TypeScript types instead of using @ts-ignore"

  required_patterns:
    - pattern: "import.*zod"
      when: "validating_external_data"
      message: "ALWAYS use Zod for external data validation"
    - pattern: "export const.*Schema = z\\.object"
      when: "creating_schemas"
      message: "ALWAYS define Zod schemas for data structures"
    - pattern: "export type.* = z\\.infer"
      when: "extracting_types"
      message: "ALWAYS infer TypeScript types from Zod schemas"
    - pattern: "func Test.*\\(t \\*testing\\.T\\)"
      when: "writing_tests"
      message: "ALWAYS write Go tests with proper test function signature"
    - pattern: "t\\.Run\\("
      when: "writing_table_driven_tests"
      message: "ALWAYS use t.Run() for table-driven test subtests"
    - pattern: "unknown"
      when: "type_annotations"
      message: "ALWAYS use unknown type with type guards instead of any"
    - pattern: "// TODO\\(#\\d+\\):"
      when: "todos"
      message: "ALWAYS reference issue numbers in TODO comments"
    - pattern: "error\\.Is\\("
      when: "error_handling"
      message: "ALWAYS use errors.Is() for error comparison"
    - pattern: "errors\\.As\\("
      when: "error_wrapping"
      message: "ALWAYS use errors.As() for error type assertions"
  affirmative_constraints:
    - "ALWAYS use table-driven tests in Go with t.Run() for subtests following examples/style-anchor/pkg/greeter/greeter_test.go pattern"
    - "ALWAYS run gofmt before committing to ensure consistent Go formatting"
    - "ALWAYS write docstrings for exported functions with clear purpose, parameters, return values, and examples"
    - "ALWAYS check errors immediately after function calls and wrap with context using fmt.Errorf"
    - "ALWAYS validate external inputs at entry points using Zod schemas for TypeScript or custom validators for Go"
    - "ONLY use dependencies listed in go.mod: Go 1.x, Cobra for CLI, better-sqlite3 for database"
    - "ALWAYS run go vet ./... before committing to catch common Go mistakes"
    - "ALWAYS write unit tests for new code targeting 80%+ test coverage measured by go test -cover"
    - "ALWAYS use structured logging with log levels (debug, info, error) and context fields"
    - "ALWAYS follow single responsibility principle: each function does one thing, each package has clear purpose"
    - "ALWAYS write acceptance criteria with explicit test instructions like '(test: ...)'"
    - "ALWAYS reference existing style anchors from docs/best-practices.md when implementing similar functionality"
    - "ALWAYS pass context.Context as first parameter to functions that make network calls or long operations"
    - "ALWAYS wrap errors with fmt.Errorf and use errors.Is/errors.As for error handling as shown in examples"
    - "ALWAYS follow project directory structure: cmd/prompt-stack/ for CLI commands, pkg/ for reusable packages"
    - "ALWAYS use Makefile targets: make build for building, make test for testing, make fmt for formatting"
    - "ALWAYS write integration tests for CLI commands using test helpers that simulate user input"

tasks:
  - id: "m0-001"
    title: "Initialize Go project with module structure"
    description: "Set up the basic project structure with Go module initialization. Create directory layout for cmd/, pkg/, tests/, and configuration files. This is the foundation task that enables all subsequent development."
    completed: false
    files_in_scope:
      - "go.mod"
      - "go.sum"
      - "cmd/prompt-stack/main.go"
      - "Makefile"
      - ".gitignore"
    style_anchors:
      - file: "examples/style-anchor/cmd/mytool/main.go"
        reason: "Concrete example of Go CLI structure with Cobra"
      - file: "docs/best-practices.md"
        reason: "Project structure and setup guidelines"
    estimated_duration_minutes: 45
    estimated_context_tokens: 800
    single_responsibility: "Project initialization and scaffolding"
    acceptance_criteria:
      - "go mod init completes successfully"
      - "Directory structure matches planned layout"
      - "Main.go has basic Cobra root command"
      - "Makefile has build and test targets"
    verification:
      pre_commit:
        - "go mod tidy"
        - "go build ./cmd/prompt-stack"
        - "go fmt ./..."
        - "go vet ./..."

  - id: "m0-002"
    title: "Implement core CLI commands with Cobra"
    description: "Create the command hierarchy with plan, validate, review, build, and init commands. Each command should have basic help text and placeholder Run functions. This provides the CLI surface that will be filled in by subsequent tasks."
    completed: false
    files_in_scope:
      - "cmd/prompt-stack/main.go"
      - "cmd/prompt-stack/plan.go"
      - "cmd/prompt-stack/validate.go"
      - "cmd/prompt-stack/review.go"
      - "cmd/prompt-stack/build.go"
    style_anchors:
      - file: "examples/style-anchor/cmd/mytool/main.go"
        reason: "Cobra command structure and Run function patterns"
      - file: "docs/best-practices.md"
        reason: "CLI command naming and organization guidelines"
      - file: "docs/requirements/main.md"
        reason: "Reference for CLI command interface requirements"
    dependencies: ["m0-001"]
    estimated_duration_minutes: 60
    estimated_context_tokens: 1200
    single_responsibility: "CLI command structure and basic implementation"
    acceptance_criteria:
      - "--help shows all core commands (test: command list includes plan, validate, review, build, init)"
      - "--help exits with status 0 (test: exit code is 0)"
      - "Each command has placeholder Run function (test: all command files compile without errors)"
      - "Commands follow consistent naming pattern (test: command names match pattern validation)"
    verification:
      pre_commit:
        - "go build ./cmd/prompt-stack"
        - "./prompt-stack --help"
        - "go test ./cmd/prompt-stack"

  - id: "m0-003"
    title: "Bundle and integrate Ralphy shell executor"
    description: "Create the executor package that manages the vendored ralphy.sh script. Implement materialization at runtime with dry-run mode that writes to report files. This enables the tool to orchestrate Ralphy execution even though full OpenCode integration is out of scope."
    completed: false
    files_in_scope:
      - "pkg/executor/executor.go"
      - "pkg/executor/dry_run.go"
      - "prompt-stack/vendor/ralphy/ralphy.sh"
      - ".prompt-stack/report.txt"
      - ".prompt-stack/audit.log"
    style_anchors:
      - file: "examples/style-anchor/pkg/greeter/greeter.go"
        reason: "Simple package structure with clear exports"
      - file: "docs/best-practices.md"
        reason: "Package design and export patterns"
      - file: "docs/requirements/main.md"
        reason: "Ralphy integration requirements and dry-run specification"
    dependencies: ["m0-001"]
    estimated_duration_minutes: 90
    estimated_context_tokens: 1500
    single_responsibility: "Ralphy executor integration and dry-run support"
    acceptance_criteria:
      - "ralphy.sh is embedded or vendored (test: file exists at prompt-stack/vendor/ralphy/ralphy.sh)"
      - "Dry-run mode writes to .prompt-stack/report.txt (test: report file created with expected format)"
      - "Dry-run mode writes to .prompt-stack/audit.log (test: audit log contains execution details)"
      - "Executor can materialize script at runtime (test: executor_test.go validates materialization)"
      - "Dry-run mode validates inputs before execution (test: invalid inputs produce error messages)"
      - "Executor handles script execution errors gracefully (test: error cases are tested)"
    verification:
      pre_commit:
        - "go build ./pkg/executor"
        - "go test ./pkg/executor"
        - "go vet ./pkg/executor"

  - id: "m0-004"
    title: "Implement interactive requirements prompt"
    description: "Create the interactive prompt system that asks one question at a time. Capture user responses, validate them, and save to planning input YAML. Save transcript of the interview for reference. This fulfills the FR-003 requirement for interactive requirements gathering."
    completed: false
    files_in_scope:
      - "cmd/prompt-stack/init.go"
      - "pkg/prompt/prompt.go"
      - "pkg/prompt/questions.go"
      - "docs/implementation-plan/m0/requirements-interview.md"
      - "examples/requirements/templates/requirements-prompt.md"
    style_anchors:
      - file: "docs/best-practices.md"
        reason: "Interactive CLI patterns and user experience guidelines"
      - file: "examples/style-anchor/pkg/greeter/greeter.go"
        reason: "Simple function-based API pattern for prompt interactions"
      - file: "docs/requirements/main.md"
        reason: "Requirements prompt specification and interview flow"
    dependencies: ["m0-002"]
    estimated_duration_minutes: 75
    estimated_context_tokens: 1400
    single_responsibility: "Interactive requirements gathering system"
    acceptance_criteria:
      - "Prompt displays questions sequentially (test: prompt_test.go validates question flow)"
      - "User responses are captured and validated (test: validation logic rejects invalid inputs)"
      - "Final output saves to YAML file matching template schema (test: generated YAML passes schema validation)"
      - "Transcript of interview is saved (test: transcript file contains all Q&A)"
      - "Input validation provides helpful error messages (test: invalid inputs produce clear errors)"
      - "Prompt handles cancellation gracefully (test: Ctrl+C exits cleanly)"
    verification:
      pre_commit:
        - "go build ./pkg/prompt"
        - "go test ./pkg/prompt"
        - "go vet ./pkg/prompt"

  - id: "m0-005"
    title: "Create project documentation and README"
    description: "Write comprehensive documentation including README with usage instructions, contributing guidelines, and architecture overview. Document the commands and their options. This ensures the project is approachable and maintainable."
    completed: false
    files_in_scope:
      - "README.md"
      - "CONTRIBUTING.md"
      - "docs/architecture.md"
      - "docs/commands.md"
      - "docs/implementation-plan/m0/requirements.md"
    style_anchors:
      - file: "examples/style-anchor/README.md"
        reason: "Example of clear, concise README structure"
      - file: "docs/best-practices.md"
        reason: "Documentation standards and guidelines"
    dependencies: ["m0-002", "m0-004"]
    estimated_duration_minutes: 45
    estimated_context_tokens: 1000
    single_responsibility: "Project documentation and user guides"
    acceptance_criteria:
      - "README describes tool purpose and core features (test: README contains required sections)"
      - "Usage examples for each command (test: examples exist for all 5 core commands)"
      - "Architecture overview explains components (test: architecture.md exists and describes components)"
      - "Contributing guidelines present (test: CONTRIBUTING.md exists with guidelines)"
    verification:
      pre_commit:
        - "spelling check on docs/**"

  - id: "m0-006"
    title: "Add unit tests and testing infrastructure"
    description: "Create unit tests for core packages using table-driven test patterns. Set up test runner and coverage reporting. Ensure tests can be run via Makefile. This fulfills the non-functional requirement for basic unit tests."
    completed: false
    files_in_scope:
      - "cmd/prompt-stack/main_test.go"
      - "pkg/executor/executor_test.go"
      - "pkg/prompt/prompt_test.go"
      - "Makefile"
      - ".github/workflows/test.yml"
    style_anchors:
      - file: "examples/style-anchor/pkg/greeter/greeter_test.go"
        reason: "Table-driven test pattern for Go packages"
      - file: "docs/best-practices.md"
        reason: "Testing guidelines and TDD patterns"
      - file: "docs/task-sizing.md"
        reason: "Test sizing and structure guidance"
    dependencies: ["m0-002", "m0-003", "m0-004"]
    estimated_duration_minutes: 60
    estimated_context_tokens: 1300
    single_responsibility: "Testing infrastructure and unit test coverage"
    acceptance_criteria:
      - "Unit tests for all core packages"
      - "Tests use table-driven pattern"
      - "make test runs all tests"
      - "Coverage reporting configured"
    verification:
      pre_commit:
        - "go test -v -cover ./..."
        - "go vet ./..."

  - id: "m0-007"
    title: "Complete build system and packaging configuration"
    description: "Finalize Makefile with all build, test, and clean targets. Add build instructions and ensure to binary can be built with Go toolchain. Add versioning and release preparation. This completes the M0 deliverables."
    completed: false
    files_in_scope:
      - "Makefile"
      - "build.sh"
      - ".github/workflows/release.yml"
      - "cmd/prompt-stack/version.go"
      - "dist/"
    style_anchors:
      - file: "examples/style-anchor/pkg/greeter/greeter.go"
        reason: "Simple package structure reference for version package"
      - file: "docs/best-practices.md"
        reason: "Build system and automation guidelines"
    dependencies: ["m0-001", "m0-006"]
    estimated_duration_minutes: 30
    estimated_context_tokens: 700
    single_responsibility: "Build system and packaging"
    acceptance_criteria:
      - "make build creates working binary"
      - "make test runs all tests"
      - "make clean removes build artifacts"
      - "Binary can be executed with --help"
    verification:
      pre_commit:
        - "make build"
        - "./dist/prompt-stack --help"
        - "make test"

parallel_groups:
  m0-002: 1
  m0-003: 1
  m0-005: 2
  m0-006: 2
